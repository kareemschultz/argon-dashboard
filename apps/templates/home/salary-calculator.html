{% extends "layouts/base.html" %}

{% block stylesheets %}
<style>
    .tool-intro {
        background: linear-gradient(87deg, #172b4d 0, #1a174d 100%);
        color: white;
        padding: 2rem;
        border-radius: .375rem;
        margin-bottom: 1.5rem;
    }
    
    .allowance-info {
        background: #f6f9fc;
        border-left: 4px solid #5e72e4;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .allowance-columns {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
    }

    .allowance-column {
        flex: 1;
    }

    .results-section {
        display: none;
        margin-top: 1.5rem;
    }

    .list-check {
        list-style: none;
        padding-left: 0;
    }

    .list-check li {
        position: relative;
        padding-left: 1.75rem;
        margin-bottom: 0.5rem;
    }

    .list-check li:before {
        content: '✓';
        position: absolute;
        left: 0;
        color: #2dce89;
    }

    .list-dash {
        list-style: none;
        padding-left: 0;
    }

    .list-dash li {
        position: relative;
        padding-left: 1.75rem;
        margin-bottom: 0.5rem;
    }

    .list-dash li:before {
        content: '•';
        position: absolute;
        left: 0;
        color: #fb6340;
    }

    .form-section {
        background: white;
        border-radius: .375rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0 2rem 0 rgba(136,152,170,.15);
    }

    .insurance-options .custom-control {
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">Salary Calculator</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt--6">
    <!-- Introduction Card -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-12">
                    <h4>Income Tax Calculator (2024)</h4>
                    <p class="text-muted mb-4">Calculate your income tax based on Guyana's current tax regulations.</p>

                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-3">This Calculator Considers:</h5>
                                <ul class="mb-3">
                                    <li>National Insurance Scheme (NIS) employee contribution</li>
                                    <li>Medical and life insurance premiums</li>
                                    <li>Various payment frequencies (yearly, monthly, fortnightly, weekly)</li>
                                    <li>Personal allowances and deductions</li>
                                    <li>Child deductions ($10,000 per child monthly)</li>
                                    <li>Salary increases and adjustments</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5 class="mb-3">Key Tax Information:</h5>
                                <ul class="mb-0">
                                    <li>Basic Tax Threshold: $100,000 monthly ($1,200,000 annually)</li>
                                    <li>Child Tax Relief: Additional $10,000 monthly per child added to threshold</li>
                                    <li>Tax Rates:
                                        <ul>
                                            <li>28% on first $2,400,000 of chargeable income</li>
                                            <li>40% on excess over $2,400,000</li>
                                        </ul>
                                    </li>
                                    <li>NIS Contribution: 5.6% of gross salary (capped at $15,680 monthly)</li>
                                    <li>Medical/Life Insurance: Up to 10% of gross salary or $50,000 monthly, whichever is less</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Allowances Information -->
    <div class="card">
        <div class="card-body">
            <div class="allowance-info">
                <h5>Understanding Allowances</h5>
                <p>An allowance is a fixed amount of money or in-kind benefit given to an employee for performing specific tasks or as compensation for unusual conditions of employment. Unless specifically exempt by law, allowances are subject to tax.</p>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card bg-gradient-success">
                            <div class="card-body">
                                <h5 class="text-white">Non-Taxable Allowances</h5>
                                <ul class="list-check text-white">
                                    <li>Travelling Allowances</li>
                                    <li>Station Allowance</li>
                                    <li>Entertainment Allowance</li>
                                    <li>Subsistence Allowance</li>
                                    <li>Meal Allowance</li>
                                    <li>Security & Telephone</li>
                                    <li>Medical & Dental*</li>
                                    <li>Gratuity</li>
                                    <li>Vacation Allowance</li>
                                    <li>Laundry</li>
                                    <li>Severance Pay</li>
                                    <li>Hardline</li>
                                </ul>
                                <small class="text-white-50">* In Government Organizations</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-gradient-danger">
                            <div class="card-body">
                                <h5 class="text-white">Taxable Allowances</h5>
                                <ul class="list-dash text-white">
                                    <li>Duty Allowance</li>
                                    <li>Uniform Allowance</li>
                                    <li>Acting Allowance</li>
                                    <li>Overtime Allowance</li>
                                    <li>Housing Allowance</li>
                                    <li>Saving Scheme (Banks DIH)</li>
                                    <li>Medical & Dental**</li>
                                </ul>
                                <small class="text-white-50">** In Non-Government Organizations</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mt-3 mb-0">
                    <i class="ni ni-bell-55 mr-2"></i>
                    <strong>Note:</strong> All allowances are non-taxable for Judges.
                </div>
            </div>
        </div>
    </div>

    <!-- Calculator Form -->
    <div class="card mt-4">
        <div class="card-header">
            <h3 class="mb-0">Calculate Your Salary</h3>
        </div>
        <div class="card-body">
            <form id="salary-form" class="needs-validation" novalidate>
                <!-- Basic Information -->
                <div class="form-section">
                    <h4 class="mb-4">Basic Information</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-control-label">Basic Salary</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">$</span>
                                    </div>
                                    <input type="number" class="form-control" name="basic_salary" required min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

<!-- Allowances Section -->
<div class="form-section">
    <h4 class="mb-4">Allowances</h4>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-control-label">Number of Taxable Allowances</label>
                <input type="number" 
                       class="form-control" 
                       id="num_taxable" 
                       name="num_taxable" 
                       min="0" 
                       max="5" 
                       value="0">
            </div>
            <div id="taxable_allowances_container"></div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-control-label">Number of Non-Taxable Allowances</label>
                <input type="number" 
                       class="form-control" 
                       id="num_non_taxable" 
                       name="num_non_taxable" 
                       min="0" 
                       max="5" 
                       value="0">
            </div>
            <div id="non_taxable_allowances_container"></div>
        </div>
    </div>
</div>

<!-- Insurance and Children -->
<div class="form-section">
    <h4 class="mb-4">Insurance & Dependents</h4>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-control-label">Insurance Coverage</label>
                <div class="insurance-options">
                    <div class="custom-control custom-radio">
                        <input type="radio" id="insurance1" name="insurance_type" class="custom-control-input" value="1" checked>
                        <label class="custom-control-label" for="insurance1">No coverage</label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input type="radio" id="insurance2" name="insurance_type" class="custom-control-input" value="2">
                        <label class="custom-control-label" for="insurance2">Employee Only</label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input type="radio" id="insurance3" name="insurance_type" class="custom-control-input" value="3">
                        <label class="custom-control-label" for="insurance3">Employee & One</label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input type="radio" id="insurance4" name="insurance_type" class="custom-control-input" value="4">
                        <label class="custom-control-label" for="insurance4">Employee & Family</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-control-label">Number of Children (Tax Threshold Adjustment)</label>
                <div class="input-group">
                    <input type="number" 
                           class="form-control" 
                           name="num_children" 
                           min="0" 
                           value="0" 
                           onchange="updateTaxThreshold()">
                    <div class="input-group-append">
                        <span class="input-group-text">
                            <i class="ni ni-single-02"></i>
                        </span>
                    </div>
                </div>
                <small class="form-text text-muted">Each child adds $10,000 to your monthly tax threshold. Current threshold: $<span id="current_threshold">100,000</span></small>
            </div>
        </div>
    </div>
</div>

<!-- Deductions -->
<div class="form-section">
    <h4 class="mb-4">Other Deductions</h4>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-control-label">Loan/Car Payment Deduction</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">$</span>
                    </div>
                    <input type="number" class="form-control" name="loan_deduction" value="0" min="0">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="form-control-label">GPSU Deduction</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">$</span>
                    </div>
                    <input type="number" class="form-control" name="gpsu_deduction" value="0" min="0">
                </div>
            </div>
        </div>
    </div>
</div>

<button type="submit" class="btn btn-primary btn-lg">Calculate Salary</button>
</form>
<!-- Results Section -->
<div id="results" class="results-section">
    <!-- Initial Results -->
    <div class="card bg-gradient-default">
        <div class="card-body">
            <h4 class="text-white">Calculation Results</h4>
            <div class="row">
                <div class="col-md-6">
                    <p class="text-white mb-1">Gross Pay: $<span id="gross_pay"></span></p>
                    <p class="text-white mb-1">Tax Threshold: $<span id="tax_threshold"></span></p>
                    <p class="text-white mb-1">NIS Contribution: $<span id="nis_contribution"></span></p>
                    <p class="text-white mb-1">Insurance Deduction: $<span id="insurance_deduction"></span></p>
                    <p class="text-white mb-1">Child Deduction: $<span id="child_deduction"></span></p>
                </div>
                <div class="col-md-6">
                    <p class="text-white mb-1">PAYE Tax: $<span id="paye_tax"></span></p>
                    <p class="text-white mb-1">Total Deductions: $<span id="total_deductions"></span></p>
                    <p class="text-white mb-1">Net Pay: $<span id="net_pay"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gratuity Information -->
    <div class="card bg-gradient-info mt-4">
        <div class="card-body">
            <h4 class="text-white">Gratuity & Total Compensation</h4>
            <div class="row">
                <div class="col-md-6">
                    <p class="text-white mb-1">Monthly Gratuity: $<span id="monthly_gratuity"></span></p>
                    <p class="text-white mb-1">Semi-Annual Gratuity: $<span id="semi_annual_gratuity"></span></p>
                </div>
                <div class="col-md-6">
                    <p class="text-white mb-1">Annual Gratuity: $<span id="annual_gratuity"></span></p>
                    <p class="text-white mb-1">Total Compensation: $<span id="total_compensation"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Salary Increase Calculator -->
    <div class="card mt-4">
        <div class="card-header">
            <h4 class="mb-0">Calculate Salary Increase</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-control-label">Pay Increase Percentage</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="increase_percentage" step="0.1" min="0">
                            <div class="input-group-append">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-control-label">Is the increase taxable?</label>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="taxable_yes" name="increase_taxable" class="custom-control-input" value="yes" checked>
                            <label class="custom-control-label" for="taxable_yes">Yes</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="taxable_no" name="increase_taxable" class="custom-control-input" value="no">
                            <label class="custom-control-label" for="taxable_no">No</label>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-primary mt-3" onclick="calculateIncrease()">Calculate Increase</button>
        </div>
    </div>

    <!-- Increased Salary Results -->
    <div id="increase_results" class="card mt-4" style="display: none;">
        <div class="card-body">
            <h4>Results with Salary Increase</h4>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1">New Gross Pay: $<span id="new_gross_pay"></span></p>
                    <p class="mb-1">New NIS Contribution: $<span id="new_nis"></span></p>
                    <p class="mb-1">New PAYE Tax: $<span id="new_paye"></span></p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1">New Total Deductions: $<span id="new_deductions"></span></p>
                    <p class="mb-1">New Net Pay: $<span id="new_net_pay"></span></p>
                    <p class="mb-1">New Total Compensation: $<span id="new_total_compensation"></span></p>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
// Function to generate allowance input fields
// Add this to your JavaScript section
function generateAllowanceFields(type) {
    // Debug logs
    console.log('Generating fields for type:', type);
    
    // Get the correct container
    const containerId = type === 'taxable' ? 'taxable_allowances_container' : 'non_taxable_allowances_container';
    const container = document.getElementById(containerId);
    
    console.log('Container found:', containerId);
    
    // Get the number of allowances
    const inputId = type === 'taxable' ? 'num_taxable' : 'num_non_taxable';
    const count = parseInt(document.getElementById(inputId).value) || 0;
    
    console.log('Number of allowances:', count);
    
    // Clear the container
    container.innerHTML = '';
    
    // Generate fields
    for (let i = 0; i < count; i++) {
        const fieldHtml = `
            <div class="form-group">
                <label class="form-control-label">${type === 'taxable' ? 'Taxable' : 'Non-Taxable'} Allowance ${i + 1}</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">$</span>
                    </div>
                    <input type="number" 
                           class="form-control" 
                           id="${type}_allowance_${i}" 
                           name="${type}_allowance_${i}" 
                           placeholder="Enter amount" 
                           required 
                           min="0"
                           value="0">
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', fieldHtml);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners for both allowance inputs
    const taxableInput = document.getElementById('num_taxable');
    const nonTaxableInput = document.getElementById('num_non_taxable');
    
    if (taxableInput) {
        taxableInput.addEventListener('input', () => generateAllowanceFields('taxable'));
    }
    
    if (nonTaxableInput) {
        nonTaxableInput.addEventListener('input', () => generateAllowanceFields('non-taxable'));
    }
});

// Separate function to initialize allowance fields
function initializeAllowanceFields() {
    ['taxable', 'non-taxable'].forEach(type => {
        const input = document.getElementById(`num_${type}`);
        if (input) {
            // Remove any existing event listeners
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
            
            // Add new event listener
            newInput.addEventListener('input', function() {
                console.log(`${type} allowance count changed to:`, this.value);
                generateAllowanceFields(type);
            });

            // Generate initial fields if value exists
            if (newInput.value > 0) {
                generateAllowanceFields(type);
            }
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeAllowanceFields();
});

// Enhanced initialization
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for both allowance inputs
    ['taxable', 'non-taxable'].forEach(type => {
        const input = document.getElementById(`num_${type}`);
        if (input) {
            // Add both change and input events
            ['change', 'input'].forEach(eventType => {
                input.addEventListener(eventType, function() {
                    console.log(`${type} allowance count changed to:`, this.value);
                    generateAllowanceFields(type);
                });
            });
        }
    });
});

// Function to update tax threshold based on number of children
function updateTaxThreshold() {
    const numChildren = parseInt(document.querySelector('input[name="num_children"]').value) || 0;
    const baseThreshold = 100000; // Base monthly threshold
    const childDeduction = 10000; // Per child monthly deduction
    const totalThreshold = baseThreshold + (numChildren * childDeduction);
    
    // Update displayed threshold
    const thresholdElement = document.getElementById('current_threshold');
    if (thresholdElement) {
        thresholdElement.textContent = totalThreshold.toLocaleString();
    }
    
    return totalThreshold;
}

// Function to format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'GYD',
        minimumFractionDigits: 2
    }).format(amount);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for allowance inputs
    ['taxable', 'non-taxable'].forEach(type => {
        const input = document.getElementById(`num_${type}`);
        if (input) {
            input.addEventListener('change', function() {
                generateAllowanceFields(type);
            });
            // Generate initial fields if value exists
            if (input.value > 0) {
                generateAllowanceFields(type);
            }
        }
    });

    // Add event listener for child deduction
    const childInput = document.querySelector('input[name="num_children"]');
    if (childInput) {
        childInput.addEventListener('change', updateTaxThreshold);
    }

    // Initialize tax threshold display
    updateTaxThreshold();
});

// Handle form submission
document.getElementById('salary-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Show loading state
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
    submitButton.disabled = true;

    const formData = new FormData(this);
    
    fetch('/calculate-salary', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Update all result fields
        Object.keys(data).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = data[key].toLocaleString();
            }
        });
        
        // Show results section
        document.getElementById('results').style.display = 'block';
        
        // Smooth scroll to results
        document.getElementById('results').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while calculating the salary');
    })
    .finally(() => {
        // Restore button state
        submitButton.innerHTML = originalButtonText;
        submitButton.disabled = false;
    });
});

// Handle salary increase calculation
function calculateIncrease() {
    const percentage = document.getElementById('increase_percentage').value;
    const taxable = document.querySelector('input[name="increase_taxable"]:checked').value;
    
    // Validate percentage
    if (!percentage || percentage <= 0) {
        alert('Please enter a valid increase percentage');
        return;
    }
    
    const formData = new FormData(document.getElementById('salary-form'));
    formData.append('increase_percentage', percentage);
    formData.append('increase_taxable', taxable);
    
    // Show loading state
    const increaseButton = document.querySelector('button[onclick="calculateIncrease()"]');
    const originalButtonText = increaseButton.innerHTML;
    increaseButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
    increaseButton.disabled = true;

    fetch('/calculate-salary-increase', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Update increase results
        Object.keys(data).forEach(key => {
            const element = document.getElementById('new_' + key);
            if (element) {
                element.textContent = data[key].toLocaleString();
            }
        });
        
        // Show increase results
        document.getElementById('increase_results').style.display = 'block';
        
        // Smooth scroll to increase results
        document.getElementById('increase_results').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while calculating the salary increase');
    })
    .finally(() => {
        // Restore button state
        increaseButton.innerHTML = originalButtonText;
        increaseButton.disabled = false;
    });
}

// Helper function to validate numeric inputs
function validateNumericInput(input) {
    input.value = input.value.replace(/[^0-9]/g, '');
    if (input.value < 0) input.value = 0;
}
</script>
{% endblock %}